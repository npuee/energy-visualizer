<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title id="page-title"></title>
    <script src="/static/language.js"></script>
    <script src="/static/plotly-2.24.2.min.js"></script>
    <link href="/static/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/custom.css" />
  </head>
  <body>
    <div class="container py-4">
      <div class="row mb-4">
        <div class="col-12">
          <div id="chart" class="border rounded shadow-sm"></div>
        </div>
      </div>
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex flex-row flex-wrap justify-content-center gap-3" id="summary"></div>
        </div>
      </div>
      <div class="row">
        <div class="col-12 text-end">
          <div id="fetched" class="text-muted small"></div>
        </div>
      </div>
    </div>

    <script>
      async function getData() {
        const r = await fetch('/data');
        return await r.json();
      }

      function render(data) {
        const dates = data.dates;
        const total = data.total;

        const traces = [];
        // Total as bar (colorful)
        traces.push({ x: dates, y: total, type: 'bar', name: LANG.LEGEND_TOTAL, marker: { color: '#2298b2', line: { color: '#17607a', width: 1 }, opacity: 0.95 } });

        // Color palette with different dash/marker patterns
        const palette = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf'];
        const styles = [
          { color: palette[0], dash:'solid', symbol:'circle' },
          { color: palette[1], dash:'dash', symbol:'square' },
          { color: palette[2], dash:'dot', symbol:'diamond' },
          { color: palette[3], dash:'dashdot', symbol:'cross' },
          { color: palette[4], dash:'longdash', symbol:'x' },
          { color: palette[5], dash:'longdashdot', symbol:'triangle-up' }
        ];

        // Per-meter lines: shorten long labels and show full label in hover
        (data.series || []).forEach((s, idx) => {
          const style = styles[idx % styles.length];
          const shortLabel = (s.label && s.label.length > 40) ? s.label.slice(0, 37) + '...' : s.label;
          const labelForLegend = s.display || shortLabel;
            traces.push({
              x: dates,
              y: s.values,
              type: 'scatter',
              mode: 'lines+markers',
              name: labelForLegend,
              text: s.display || s.label,
              hovertemplate: '%{y} kWh<extra></extra>',
              line: { color: s.color || style.color, dash: style.dash, width: 2.5 },
              marker: { size: 6, symbol: style.symbol, color: s.color || style.color }
            });
        });

        const layout = {
          title: LANG.PLOT_TITLE,
          xaxis: { title: LANG.X_AXIS },
          yaxis: { title: LANG.Y_AXIS },
          // place legend horizontally at the bottom to avoid overlapping labels
          legend: {
            orientation: 'h',
            x: 0.5,
            xanchor: 'center',
            y: -0.25,
            font: { size: 14 }
          },
          margin: { b: 120 }
        };

        Plotly.newPlot('chart', traces, layout, {
          responsive: true,
          displayModeBar: false
        });

        // Summary
        const s = data.summary || {};
        const summaryEl = document.getElementById('summary');
        summaryEl.innerHTML = '';
        const items = [
          { label: LANG.SUMMARY_TOTAL, value: s.total_kwh },
          { label: LANG.SUMMARY_AVG, value: s.avg_per_day_kwh },
          { label: LANG.SUMMARY_MIN, value: s.min_day_kwh },
          { label: LANG.SUMMARY_MAX, value: s.max_day_kwh },
          { label: LANG.SUMMARY_TODAY, value: s.today_kwh }
        ];
        items.forEach(item => {
          const col = document.createElement('div');
          col.className = 'col-auto md-3 d-flex flex-row flex-wrap';
          col.innerHTML = `<div class="card h-100 shadow-sm md-3"><div class="card-body text-center"><h6 class="card-title">${item.label}</h6><div class="card-text fs-4">${item.value}</div></div></div>`;
          summaryEl.appendChild(col);
        });
        const fetchedEl = document.getElementById('fetched');
        if (data.fetched_at_ts) {
          // prefer epoch seconds to avoid ambiguous date parsing across browsers
          try {
            const d = new Date(Math.round(data.fetched_at_ts * 1000));
            fetchedEl.textContent = LANG.DATA_UPDATED + ' ' + d.toLocaleString(undefined, { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false, timeZoneName: 'short' });
          } catch (e) {
            fetchedEl.textContent = LANG.DATA_UPDATED + ' ' + data.fetched_at;
          }
        } else if (data.fetched_at) {
          try {
            const d = new Date(data.fetched_at);
            fetchedEl.textContent = LANG.DATA_UPDATED + ' ' + d.toLocaleString(undefined, { timeZoneName: 'short' });
          } catch (e) {
            fetchedEl.textContent = LANG.DATA_UPDATED + ' ' + data.fetched_at;
          }
        } else {
          fetchedEl.textContent = '';
        }
      }

      // Set static text from language file
      document.getElementById('page-title').textContent = LANG.TITLE;
      document.title = LANG.TITLE;
      (async ()=>{
        const data = await getData();
        render(data);
      })();
    </script>
  </body>
</html>